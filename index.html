import React, { useState, useContext, createContext, useEffect } from 'react';

// --- MOCK DATABASE (INITIAL STATE) ---
const initialData = {
  users: [
	{ id: 's1', name: 'Budi Santoso', class: 'XI IPA 2', gender: 'Laki-laki', role: 'student', username: 'budi', password: '123' },
	{ id: 's2', name: 'Citra Lestari', class: 'X IPS 1', gender: 'Perempuan', role: 'student', username: 'citra', password: '123' },
	{ id: 's3', name: 'Dewi Anggraini', class: 'XII Bahasa', gender: 'Perempuan', role: 'student', username: 'dewi', password: '123' },
	{ id: 'g1', name: 'Ahmad Dahlan', gender: 'Laki-laki', role: 'teacher', username: 'guru', password: 'guru123' },
	{ id: 'g2', name: 'Siti Hartinah', gender: 'Perempuan', role: 'teacher', username: 'siti', password: 'guru' },
  ],
  ekskul: [
	{ id: 'e1', name: 'Basket', description: 'Mengembangkan bakat bermain bola basket, fisik, dan kerjasama tim.', coachId: 'g1' },
	{ id: 'e2', name: 'Pramuka', description: 'Membentuk karakter, kepemimpinan, dan kecintaan pada alam.', coachId: 'g2' },
	{ id: 'e3', name: 'Klub Musik', description: 'Mempelajari alat musik, vokal, dan aransemen lagu bersama.', coachId: 'g1' },
	{ id: 'e4', name: 'Jurnalistik', description: 'Belajar teknik menulis berita, wawancara, dan fotografi.', coachId: 'g2' },
  ],
  registrations: [
	{ studentId: 's1', ekskulId: 'e1' }, { studentId: 's1', ekskulId: 'e3' },
	{ studentId: 's2', ekskulId: 'e2' }, { studentId: 's3', ekskulId: 'e4' },
  ],
  schedule: [
	{ id: 'sch1', ekskulId: 'e1', day: 'Selasa', time: '15:30 - 17:00', location: 'Lapangan Basket Outdoor' },
	{ id: 'sch2', ekskulId: 'e2', day: 'Jumat', time: '14:00 - 16:00', location: 'Lapangan Utama Sekolah' },
  ],
  attendance: [
	{ id: 'att1', studentId: 's1', ekskulId: 'e1', date: '2025-09-02', status: 'Hadir' },
	{ id: 'att2', studentId: 's2', ekskulId: 'e2', date: '2025-09-05', status: 'Hadir' },
  ],
  forum: [
  	{ id: 'f1', ekskulId: 'e1', title: 'Jadwal Tanding Persahabatan', authorId: 'g1', posts: [
      	{ authorId: 'g1', message: 'Anak-anak, kita ada rencana tanding persahabatan minggu depan. Ada usul lawan?' },
      	{ authorId: 's1', message: 'Lawan SMA sebelah seru kayaknya, Pak!' },
  	]},
  ],
  gallery: [
	{ id: 'gal1', ekskulId: 'e1', imageUrl: 'https://placehold.co/600x400/007bff/FFFFFF?text=Latihan+Basket', caption: 'Sesi latihan dribble' },
	{ id: 'gal2', ekskulId: 'e2', imageUrl: 'https://placehold.co/600x400/28a745/FFFFFF?text=Api+Unggun', caption: 'Malam keakraban di api unggun' },
  ]
};

// --- React Context for State Management ---
const AppContext = createContext();

const AppProvider = ({ children }) => {
	const [db, setDb] = useState(initialData);
	const [currentUser, setCurrentUser] = useState(null);
    const [modal, setModal] = useState({ isOpen: false, title: '', content: '', onConfirm: null });
    const [toast, setToast] = useState({ isVisible: false, message: '' });

    const showToast = (message) => {
        setToast({ isVisible: true, message });
        setTimeout(() => setToast({ isVisible: false, message: '' }), 3000);
    };

    const showModal = ({ title, content, onConfirm }) => {
        setModal({ isOpen: true, title, content, onConfirm });
    };

    const hideModal = () => {
        setModal({ isOpen: false, title: '', content: '', onConfirm: null });
    };

    const handleConfirm = () => {
        if (modal.onConfirm) {
            modal.onConfirm();
        }
        hideModal();
    };

	const findUser = (id) => db.users.find(u => u.id === id);
	const findEkskul = (id) => db.ekskul.find(e => e.id === id);
	
	const actions = {
    	login: (user) => {
        	const foundUser = db.users.find(u => u.username === user.username && u.password === user.password && u.role === user.role);
        	if (foundUser) {
                setCurrentUser(foundUser);
            	return foundUser;
        	}
        	return null;
    	},
    	logout: () => setCurrentUser(null),
    	updateUser: (updatedUser) => {
        	setDb(prev => ({...prev, users: prev.users.map(u => u.id === updatedUser.id ? updatedUser : u) }));
        	if (currentUser && currentUser.id === updatedUser.id) {
                setCurrentUser(updatedUser);
        	}
    	},
    	addUser: (newUser) => setDb(prev => ({...prev, users: [...prev.users, {id: `${newUser.role.charAt(0)}${Date.now()}`, ...newUser}]})),
    	deleteUser: (id) => setDb(prev => ({...prev, users: prev.users.filter(u => u.id !== id)})),
 
    	addEkskul: (newEkskul) => setDb(prev => ({ ...prev, ekskul: [...prev.ekskul, {id: `e${Date.now()}`, ...newEkskul}] })),
    	updateEkskul: (updatedEkskul) => setDb(prev => ({...prev, ekskul: prev.ekskul.map(e => e.id === updatedEkskul.id ? updatedEkskul : e)})),
    	deleteEkskul: (id) => setDb(prev => ({ ...prev, ekskul: prev.ekskul.filter(e => e.id !== id)})),
    	
        registerToEkskul: (studentId, ekskulId) => setDb(prev => ({ ...prev, registrations: [...prev.registrations, {studentId, ekskulId}]})),
    	
    	addForum: (newForum) => setDb(prev => ({ ...prev, forum: [...prev.forum, {id: `f${Date.now()}`, posts: [], ...newForum}]})),
    	addForumPost: (forumId, newPost) => {
        	setDb(prev => ({
                ...prev,
            	forum: prev.forum.map(f => f.id === forumId ? {...f, posts: [...f.posts, newPost]} : f)
        	}));
    	},
    	addPhoto: (newPhoto) => setDb(prev => ({...prev, gallery: [...prev.gallery, {id: `gal${Date.now()}`, ...newPhoto}]})),
    	deletePhoto: (id) => setDb(prev => ({...prev, gallery: prev.gallery.filter(p => p.id !== id)})),
        updateAttendance: (attendanceId, newStatus) => {
        	setDb(prev => ({
                ...prev,
                attendance: prev.attendance.map(a => a.id === attendanceId ? {...a, status: newStatus} : a)
        	}));
    	},
    	addSchedule: (newSchedule) => setDb(prev => ({...prev, schedule: [...prev.schedule, {id: `sch${Date.now()}`, ...newSchedule}]})),
	};
 
	const value = { db, setDb, currentUser, findUser, findEkskul, ...actions, modal, showModal, hideModal, handleConfirm, toast, showToast };
    return <AppContext.Provider value={value}>{children}</AppContext.Provider>;
}
 
const useAppContext = () => useContext(AppContext);
 
// --- Icon Components ---
const HomeIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>;
const RegisterIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" x2="3" y1="12" y2="12"></line></svg>;
const ForumIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>;
const GalleryIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></svg>;
const ScheduleIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg>;
const AttendanceIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><polyline points="16 11 18 13 22 9"></polyline></svg>;
const ProfileIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
const ManageDataIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" x2="12" y1="18" y2="12"></line><line x1="9" x2="15" y1="15" y2="15"></line></svg>;
const LogoutIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" x2="9" y1="12" y2="12"></line></svg>;
const PlusIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
const UserIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
const LockIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>;
const TrashIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>;
const InfoIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>;

// --- UI Components ---
const Card = ({ children, className }) => (<div className={`bg-white rounded-xl shadow-md p-6 ${className}`}>{children}</div>);
const Button = ({ children, onClick, className, variant = 'primary', type='button', disabled=false }) => {
	const baseClasses = 'px-4 py-2 rounded-lg font-semibold flex items-center justify-center gap-2 transition-transform transform hover:scale-105 disabled:opacity-50 disabled:scale-100';
	const variantClasses = {
    	primary: 'bg-blue-600 text-white hover:bg-blue-700',
    	secondary: 'bg-gray-200 text-gray-800 hover:bg-gray-300',
    	success: 'bg-green-500 text-white hover:bg-green-600',
    	danger: 'bg-red-500 text-white hover:bg-red-600',
    	dangerOutline: 'border border-red-500 text-red-500 hover:bg-red-50',
	};
	return <button type={type} onClick={onClick} className={`${baseClasses} ${variantClasses[variant]} ${className}`} disabled={disabled}>{children}</button>;
};
const PageTitle = ({ title, subtitle }) => (
	<div className="mb-6">
    	<h1 className="text-3xl font-bold text-gray-800">{title}</h1>
    	{subtitle && <p className="text-gray-500 mt-1">{subtitle}</p>}
	</div>
);
const Modal = () => {
    const { modal, hideModal, handleConfirm } = useAppContext();
    if (!modal.isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center">
            <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
                <h3 className="text-xl font-bold text-gray-900">{modal.title}</h3>
                <p className="mt-2 text-gray-600">{modal.content}</p>
                <div className="mt-6 flex justify-end gap-4">
                    <Button variant="secondary" onClick={hideModal}>Batal</Button>
                    <Button variant="primary" onClick={handleConfirm}>Konfirmasi</Button>
                </div>
            </div>
        </div>
    );
};
const Toast = () => {
    const { toast } = useAppContext();
    const [visible, setVisible] = useState(false);

    useEffect(() => {
        if (toast.isVisible) {
            setVisible(true);
            const timer = setTimeout(() => {
                setVisible(false);
            }, 2800); // A bit shorter than context timer to allow fade-out
            return () => clearTimeout(timer);
        }
    }, [toast]);


    return (
        <div className={`fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-3 transition-all duration-300 z-50 ${visible ? 'transform translate-y-0 opacity-100' : 'transform translate-y-5 opacity-0'}`}>
            <InfoIcon className="text-blue-400" />
            <span>{toast.message}</span>
        </div>
    );
};

// --- Layout Components ---
const Header = () => {
	const { currentUser, logout } = useAppContext();
	return (
	<header className="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
    	<h1 className="text-xl font-bold text-blue-600">EkskulPlus</h1>
        <div className="flex items-center gap-4">
        	<div className="text-right">
                <span className="font-semibold text-gray-700">{currentUser.name}</span>
                <span className={`text-xs font-bold py-1 px-2 rounded-full ml-2 ${currentUser.role === 'teacher' ? 'bg-orange-200 text-orange-800' : 'bg-green-200 text-green-800'}`}>
                    {currentUser.role === 'teacher' ? 'Guru' : 'Siswa'}
                </span>
            </div>
        	<button onClick={logout} className="text-gray-500 hover:text-red-600 flex items-center gap-2"><LogoutIcon /><span className="hidden md:inline">Logout</span></button>
    	</div>
	</header>
	);
};
const Sidebar = ({ currentPage, setCurrentPage }) => {
	const { currentUser } = useAppContext();
	const studentMenu = [
    	{ name: 'Beranda', page: 'student_dashboard', icon: <HomeIcon /> },
    	{ name: 'Pendaftaran Ekskul', page: 'registration', icon: <RegisterIcon /> },
    	{ name: 'Jadwal Ekskul', page: 'schedule', icon: <ScheduleIcon /> },
    	{ name: 'Absensi', page: 'attendance', icon: <AttendanceIcon /> },
    	{ name: 'Forum Diskusi', page: 'forum', icon: <ForumIcon /> },
    	{ name: 'Galeri Ekskul', page: 'gallery', icon: <GalleryIcon /> },
    	{ name: 'Profil Saya', page: 'profile', icon: <ProfileIcon /> },
	];
	const teacherMenu = [
    	{ name: 'Beranda', page: 'teacher_dashboard', icon: <HomeIcon /> },
    	{ name: 'Pendaftaran', page: 'registration', icon: <RegisterIcon /> },
    	{ name: 'Jadwal Ekskul', page: 'schedule', icon: <ScheduleIcon /> },
    	{ name: 'Absensi', page: 'attendance', icon: <AttendanceIcon /> },
    	{ name: 'Forum Diskusi', page: 'forum', icon: <ForumIcon /> },
    	{ name: 'Galeri Ekskul', page: 'gallery', icon: <GalleryIcon /> },
    	{ name: 'Kelola Data', page: 'manage_data', icon: <ManageDataIcon /> },
    	{ name: 'Profil Saya', page: 'profile', icon: <ProfileIcon /> },
	];
	const menuItems = currentUser.role === 'teacher' ? teacherMenu : studentMenu;
	return (
    	<aside className="w-64 bg-gray-800 text-white flex-shrink-0 p-4 flex flex-col">
        	<nav className="flex-grow">
                <ul>
        	        {menuItems.map(item => (
                        <li key={item.page} className="mb-2">
                            <a href="#" onClick={(e) => { e.preventDefault(); setCurrentPage(item.page); }}
                                className={`flex items-center gap-3 px-4 py-3 rounded-lg transition-colors ${currentPage === item.page ? 'bg-blue-600 text-white' : 'hover:bg-gray-700'}`}
                            >{item.icon}<span className="font-medium">{item.name}</span></a>
                        </li>
                    ))}
                </ul>
            </nav>
    	</aside>
	);
};
const AppLayout = ({ currentPage, setCurrentPage, children }) => (
	<div className="flex h-screen bg-gray-100">
    	<Sidebar currentPage={currentPage} setCurrentPage={setCurrentPage} />
    	<div className="flex-1 flex flex-col overflow-hidden">
        	<Header />
        	<main className="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">{children}</main>
    	</div>
	</div>
);
 
// --- Page Components ---
const LoginPage = () => {
	const { login } = useAppContext();
	const [username, setUsername] = useState('');
	const [password, setPassword] = useState('');
	const [role, setRole] = useState('student');
	const [error, setError] = useState('');
	
	const handleSubmit = (e) => {
        e.preventDefault();
    	setError('');
    	const user = login({ username, password, role });
    	if (!user) setError('Username, password, atau role salah!');
	};
 
	return (
    	<div className="flex items-center justify-center min-h-screen bg-gray-100">
        	<div className="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-lg">
                <div className="text-center">
                    <h1 className="text-3xl font-bold text-blue-600">EkskulPlus</h1>
                    <p className="mt-2 text-gray-500">Manajemen Ekstrakurikuler Sekolah</p>
                </div>
            	{error && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">{error}</div>}
                <form className="space-y-6" onSubmit={handleSubmit}>
                    <div className="flex border rounded-lg overflow-hidden">
                        <button type="button" onClick={() => setRole('student')} className={`w-1/2 p-3 font-semibold transition-colors ${role === 'student' ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>Siswa</button>
                        <button type="button" onClick={() => setRole('teacher')} className={`w-1/2 p-3 font-semibold transition-colors ${role === 'teacher' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>Guru</button>
                    </div>
                    <div className="relative">
                        <span className="absolute inset-y-0 left-0 flex items-center pl-3"><UserIcon className="h-5 w-5 text-gray-400" /></span>
          	          <input type="text" placeholder="Username" value={username} onChange={e => setUsername(e.target.value)} className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg"/>
                    </div>
                     <div className="relative">
                        <span className="absolute inset-y-0 left-0 flex items-center pl-3"><LockIcon className="h-5 w-5 text-gray-400" /></span>
                        <input type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg"/>
                    </div>
                    <div><p className="text-xs text-center text-gray-500">Hint: Siswa (budi/123), Guru (guru/guru123)</p></div>
   	             <Button type="submit" className="w-full">Login</Button>
                </form>
            </div>
    	</div>
	);
};
 
const StudentDashboard = () => {
	const { currentUser, db, findEkskul, findUser } = useAppContext();
	const myRegistrations = db.registrations.filter(r => r.studentId === currentUser.id);
	const myEkskuls = myRegistrations.map(r => findEkskul(r.ekskulId)).filter(Boolean);
	
	return (
    	<div>
            <PageTitle title={`Selamat Datang, ${currentUser.name}!`} subtitle="Inilah ringkasan aktivitas ekstrakurikuler Anda." />
        	<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <Card className="bg-gradient-to-br from-blue-500 to-indigo-600 text-white">
    	            <h3 className="text-xl font-bold">Ekskul Diikuti</h3>
                    <p className="text-5xl font-extrabold mt-2">{myEkskuls.length}</p>
                </Card>
                 <Card className="bg-gradient-to-br from-green-500 to-emerald-600 text-white">
                    <h3 className="text-xl font-bold">Notifikasi Forum</h3>
                    <p className="text-5xl font-extrabold mt-2">2</p>
                    <p className="mt-1">Pesan baru belum dibaca</p>
                </Card>
            </div>
        	<div className="mt-8">
            	<h2 className="text-2xl font-bold text-gray-800 mb-4">Daftar Ekstrakurikuler Anda</h2>
                <Card>
                    <ul className="divide-y divide-gray-200">
          	          {myEkskuls.length > 0 ? myEkskuls.map(ekskul => (
                            <li key={ekskul.id} className="py-4 flex justify-between items-center">
                            	<div>
                                	<p className="text-lg font-semibold text-gray-900">{ekskul.name}</p>
                                	<p className="text-sm text-gray-500">Pembina: {findUser(ekskul.coachId)?.name || 'N/A'}</p>
                            	</div>
                            	<span className="text-sm font-medium text-green-600 bg-green-100 px-3 py-1 rounded-full">Terdaftar</span>
                            </li>
                        )) : <p>Anda belum terdaftar di ekskul manapun.</p>}
                    </ul>
                </Card>
            </div>
    	</div>
	);
};
 
const TeacherDashboard = () => {
	const { currentUser, db } = useAppContext();
	const myEkskuls = db.ekskul.filter(e => e.coachId === currentUser.id);
	const myEkskulIds = myEkskuls.map(e => e.id);
	const totalStudents = db.registrations.filter(r => myEkskulIds.includes(r.ekskulId)).length;
 
	return (
    	<div>
            <PageTitle title={`Selamat Datang, ${currentUser.name}!`} subtitle="Berikut adalah ringkasan ekstrakurikuler yang Anda bina." />
         	<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <Card className="bg-gradient-to-br from-orange-500 to-red-600 text-white">
                	<h3 className="text-xl font-bold">Ekskul Dibina</h3>
                    <p className="text-5xl font-extrabold mt-2">{myEkskuls.length}</p>
                </Card>
                <Card className="bg-gradient-to-br from-teal-500 to-cyan-600 text-white">
                    <h3 className="text-xl font-bold">Total Siswa</h3>
                    <p className="text-5xl font-extrabold mt-2">{totalStudents}</p>
                </Card>
                <Card className="bg-gradient-to-br from-purple-500 to-violet-600 text-white">
                    <h3 className="text-xl font-bold">Forum Aktif</h3>
                    <p className="text-5xl font-extrabold mt-2">{db.forum.filter(f => myEkskulIds.includes(f.ekskulId)).length}</p>
                </Card>
        	</div>
    	</div>
	);
};
 
const RegistrationPage = () => {
	const { currentUser, db, findUser, registerToEkskul, showModal } = useAppContext();
 
	if (currentUser.role === 'student') {
    	const myEkskulIds = db.registrations.filter(r => r.studentId === currentUser.id).map(r => r.ekskulId);
    	return (
            <div>
                <PageTitle title="Pendaftaran Ekstrakurikuler" subtitle="Pilih ekskul yang Anda minati untuk bergabung."/>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {db.ekskul.map(ekskul => (
                        <Card key={ekskul.id} className="flex flex-col">
                            <h3 className="text-xl font-bold">{ekskul.name}</h3>
                            <p className="text-sm text-gray-500 mt-1">Pembina: {findUser(ekskul.coachId)?.name}</p>
                            <p className="text-gray-600 my-4 flex-grow">{ekskul.description}</p>
                            {myEkskulIds.includes(ekskul.id) ? (
                            	<Button className="w-full" variant="success" disabled>Sudah Terdaftar</Button>
                            ) : (
                            	<Button className="w-full" onClick={() => showModal({ 
                                    title: 'Konfirmasi Pendaftaran', 
                                    content: `Apakah Anda yakin ingin mendaftar di ${ekskul.name}?`, 
                                    onConfirm: () => registerToEkskul(currentUser.id, ekskul.id)
                                })}>Daftar Sekarang</Button>
                            )}
                        </Card>
                    ))}
                </div>
            </div>
    	);
	}
	
	// Teacher View
	const myEkskuls = db.ekskul.filter(e => e.coachId === currentUser.id);
	return (
    	<div>
            <PageTitle title="Pendaftar Ekstrakurikuler" subtitle="Daftar siswa yang mendaftar di ekskul Anda." />
        	<div className="space-y-6">
                {myEkskuls.map(ekskul => (
                    <Card key={ekskul.id}>
                        <h3 className="text-xl font-bold mb-4">{ekskul.name}</h3>
                        <table className="min-w-full">
  	                      <thead><tr><th className="text-left py-2">Nama Siswa</th><th className="text-left py-2">Kelas</th></tr></thead>
                            <tbody>
                                {db.registrations.filter(r => r.ekskulId === ekskul.id).map(reg => {
                                	const student = findUser(reg.studentId);
                                	return student ? <tr key={reg.studentId} className="border-t"><td className="py-2">{student.name}</td><td className="py-2">{student.class}</td></tr> : null;
                            	})}
                            </tbody>
                        </table>
                    </Card>
            	))}
            </div>
    	</div>
	);
};
 
const ProfilePage = () => {
	const { currentUser, updateUser, showToast } = useAppContext();
	const [formData, setFormData] = useState(currentUser);
 
	const handleChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });
	
	const handleSubmit = (e) => {
 	   e.preventDefault();
        updateUser(formData);
    	showToast('Profil berhasil diperbarui!');
	};
 
	return (
    	<div>
            <PageTitle title="Profil Saya" subtitle="Lihat dan perbarui informasi data diri Anda."/>
            <Card>
                <form className="space-y-4" onSubmit={handleSubmit}>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                        <input type="text" name="name" value={formData.name} onChange={handleChange} className="mt-1 block w-full p-2 border border-gray-300 rounded-md"/>
                    </div>
                    {currentUser.role === 'student' && (
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Kelas</label>
                            <input type="text" name="class" value={formData.class} onChange={handleChange} className="mt-1 block w-full p-2 border border-gray-300 rounded-md"/>
                        </div>
   	             )}
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Jenis Kelamin</label>
                        <select name="gender" value={formData.gender} onChange={handleChange} className="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-white">
                            <option>Laki-laki</option>
                            <option>Perempuan</option>
                        </select>
                    </div>
                    <div>
        	            <label className="block text-sm font-medium text-gray-700">Username</label>
                        <input type="text" value={formData.username} readOnly className="mt-1 block w-full p-2 border bg-gray-100 text-gray-500 rounded-md"/>
                    </div>
                    <div className="pt-4"><Button type="submit">Simpan Perubahan</Button></div>
                </form>
            </Card>
    	</div>
	);
};
 
const ManageDataPage = () => {
	const { db, findUser, addUser, addEkskul, deleteEkskul, deleteUser, showModal, showToast } = useAppContext();
	const [newUser, setNewUser] = useState({ name: '', username: '', password: '', role: 'student', class: '', gender: 'Laki-laki' });
	const [newEkskul, setNewEkskul] = useState({ name: '', description: '', coachId: db.users.find(u => u.role === 'teacher')?.id || '' });
 
	const handleAddUser = (e) => {
        e.preventDefault();
        addUser(newUser);
    	setNewUser({ name: '', username: '', password: '', role: 'student', class: '', gender: 'Laki-laki' });
    	showToast('Pengguna baru ditambahkan!');
	};
	const handleAddEkskul = (e) => {
        e.preventDefault();
        addEkskul(newEkskul);
        setNewEkskul({ name: '', description: '', coachId: db.users.find(u => u.role === 'teacher')?.id || '' });
    	showToast('Ekskul baru ditambahkan!');
	};
 
	return (
    	<div>
            <PageTitle title="Kelola Data Master" subtitle="Tambah atau hapus data ekstrakurikuler dan pengguna."/>
        	<div className="space-y-8">
                <Card>
                    <h3 className="text-xl font-bold mb-4">Kelola Pengguna (Siswa/Guru)</h3>
                    <form onSubmit={handleAddUser} className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end bg-gray-50 p-4 rounded-lg mb-6">
                        <input type="text" placeholder="Nama Lengkap" value={newUser.name} onChange={e => setNewUser({...newUser, name: e.target.value})} className="p-2 border border-gray-300 rounded" required />
                        <input type="text" placeholder="Username" value={newUser.username} onChange={e => setNewUser({...newUser, username: e.target.value})} className="p-2 border border-gray-300 rounded" required />
                 	   <input type="password" placeholder="Password" value={newUser.password} onChange={e => setNewUser({...newUser, password: e.target.value})} className="p-2 border border-gray-300 rounded" required />
                        <select value={newUser.role} onChange={e => setNewUser({...newUser, role: e.target.value})} className="p-2 border border-gray-300 rounded bg-white">
                            <option value="student">Siswa</option>
                            <option value="teacher">Guru</option>
                        </select>
                        {newUser.role === 'student' && <input type="text" placeholder="Kelas" value={newUser.class} onChange={e => setNewUser({...newUser, class: e.target.value})} className="p-2 border border-gray-300 rounded" />}
                        <Button type="submit"><PlusIcon/> Tambah Pengguna</Button>
                    </form>
                    <table className="min-w-full">
                        <thead><tr><th className="text-left py-2">Nama</th><th className="text-left py-2">Role</th><th className="text-left py-2">Aksi</th></tr></thead>
                        <tbody>{db.users.map(user => <tr key={user.id} className="border-t"><td className="py-2">{user.name}</td><td className="py-2">{user.role}</td><td><Button variant="dangerOutline" onClick={() => showModal({title:'Konfirmasi Hapus', content: `Hapus ${user.name}?`, onConfirm: () => deleteUser(user.id)})}>Hapus</Button></td></tr>)}</tbody>
                    </table>
                </Card>
                <Card>
                    <h3 className="text-xl font-bold mb-4">Kelola Ekstrakurikuler</h3>
                    <form onSubmit={handleAddEkskul} className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end bg-gray-50 p-4 rounded-lg mb-6">
                        <input type="text" placeholder="Nama Ekskul" value={newEkskul.name} onChange={e => setNewEkskul({...newEkskul, name: e.target.value})} className="p-2 border border-gray-300 rounded" required />
                        <input type="text" placeholder="Deskripsi" value={newEkskul.description} onChange={e => setNewEkskul({...newEkskul, description: e.target.value})} className="p-2 border border-gray-300 rounded" required />
                 	   <select value={newEkskul.coachId} onChange={e => setNewEkskul({...newEkskul, coachId: e.target.value})} className="p-2 border border-gray-300 rounded bg-white">
                            {db.users.filter(u => u.role === 'teacher').map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                        </select>
                        <Button type="submit"><PlusIcon/> Tambah Ekskul</Button>
                    </form>
                    <table className="min-w-full">
                        <thead><tr><th className="text-left py-2">Nama Ekskul</th><th className="text-left py-2">Pembina</th><th className="text-left py-2">Aksi</th></tr></thead>
                        <tbody>{db.ekskul.map(e => <tr key={e.id} className="border-t"><td className="py-2">{e.name}</td><td className="py-2">{findUser(e.coachId)?.name}</td><td><Button variant="dangerOutline" onClick={() => showModal({title:'Konfirmasi Hapus', content:`Hapus ${e.name}?`, onConfirm: () => deleteEkskul(e.id)})}>Hapus</Button></td></tr>)}</tbody>
                    </table>
                </Card>
            </div>
    	</div>
	);
};
 
const SchedulePage = () => {
	const { currentUser, db, findEkskul, addSchedule, showToast } = useAppContext();
	const [isAdding, setIsAdding] = useState(false);
	const [newSchedule, setNewSchedule] = useState({ ekskulId: '', day: 'Senin', time: '', location: '' });
 
	const myEkskuls = db.ekskul.filter(e => e.coachId === currentUser.id);
    
    useEffect(() => {
        if(myEkskuls.length > 0 && newSchedule.ekskulId === '') {
            setNewSchedule(prev => ({...prev, ekskulId: myEkskuls[0].id}));
        }
    }, [myEkskuls]);
 
	const handleAdd = (e) => {
        e.preventDefault();
        if(!newSchedule.ekskulId || !newSchedule.time || !newSchedule.location) {
            showToast("Harap isi semua field!");
        	return;
    	}
        addSchedule(newSchedule);
        setIsAdding(false);
        setNewSchedule({ ekskulId: myEkskuls.length > 0 ? myEkskuls[0].id : '', day: 'Senin', time: '', location: '' });
	}
 
	return (
   	<div>
           <PageTitle title="Jadwal Ekstrakurikuler" subtitle="Lihat jadwal lengkap semua kegiatan ekstrakurikuler."/>
       	{currentUser.role === 'teacher' && <div className="flex justify-end mb-4"><Button onClick={() => setIsAdding(!isAdding)}><PlusIcon/> {isAdding ? 'Batal' : 'Tambah Jadwal'}</Button></div>}
       	{isAdding && (
               <Card className="mb-6">
                   <form onSubmit={handleAdd} className="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                       <select value={newSchedule.ekskulId} onChange={e => setNewSchedule({...newSchedule, ekskulId: e.target.value})} className="w-full p-2 border border-gray-300 rounded bg-white">
                           {myEkskuls.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                       </select>
                       <select value={newSchedule.day} onChange={e => setNewSchedule({...newSchedule, day: e.target.value})} className="w-full p-2 border border-gray-300 rounded bg-white">
                           {['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat'].map(d => <option key={d} value={d}>{d}</option>)}
                       </select>
            	       <input type="text" placeholder="Waktu (e.g. 15:30 - 17:00)" value={newSchedule.time} onChange={e => setNewSchedule({...newSchedule, time: e.target.value})} className="w-full p-2 border border-gray-300 rounded"/>
                       <input type="text" placeholder="Lokasi" value={newSchedule.location} onChange={e => setNewSchedule({...newSchedule, location: e.target.value})} className="w-full p-2 border border-gray-300 rounded"/>
                       <Button type="submit">Simpan</Button>
                   </form>
          	 </Card>
       	)}
            <Card>
           	<div className="overflow-x-auto">
                   <table className="min-w-full divide-y divide-gray-200">
                       <thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left">Hari</th><th className="px-6 py-3 text-left">Waktu</th><th className="px-6 py-3 text-left">Nama Ekskul</th><th className="px-6 py-3 text-left">Lokasi</th></tr></thead>
                        <tbody className="bg-white divide-y divide-gray-200">
   	                    {db.schedule.sort((a,b) => ['Senin','Selasa','Rabu','Kamis','Jumat'].indexOf(a.day) - ['Senin','Selasa','Rabu','Kamis','Jumat'].indexOf(b.day)).map(item => (
                           	<tr key={item.id}>
                                   <td className="px-6 py-4">{item.day}</td>
                               	<td className="px-6 py-4">{item.time}</td>
                               	<td className="px-6 py-4 font-semibold">{findEkskul(item.ekskulId)?.name}</td>
           	                    <td className="px-6 py-4">{item.location}</td>
                           	</tr>
                           ))}
                       </tbody>
                   </table>
               </div>
           </Card>
   	</div>
	);
}
 
const AttendancePage = () => {
	const { currentUser, db, findEkskul, findUser, setDb, updateAttendance, showToast } = useAppContext();
	const todayString = new Date().toISOString().split('T')[0];
 
	const handleAttend = (ekskulId, status) => {
    	const newAttendance = { id: `att${Date.now()}`, studentId: currentUser.id, ekskulId, date: todayString, status };
    	setDb(prev => ({ ...prev, attendance: [...prev.attendance, newAttendance] }));
    	showToast(`Absensi ${status} berhasil dicatat.`);
	}
 
	if (currentUser.role === 'student') {
    	const myEkskuls = db.registrations.filter(r => r.studentId === currentUser.id).map(r => findEkskul(r.ekskulId)).filter(Boolean);
    	return (
            <div>
                <PageTitle title="Absensi Kehadiran" subtitle={`Catat kehadiran Anda untuk hari ini.`}/>
                <div className="space-y-4">
                {myEkskuls.map(ekskul => {
                    const myAttendanceToday = db.attendance.find(a => a.studentId === currentUser.id && a.ekskulId === ekskul.id && a.date === todayString);
                    return(
                    <Card key={ekskul.id} className="flex flex-col md:flex-row justify-between items-center">
                        <h3 className="text-xl font-bold text-gray-800 mb-4 md:mb-0">{ekskul.name}</h3>
                        {myAttendanceToday ? (
                             <div className="text-lg font-semibold">Anda sudah absen: <span className={`px-3 py-1 rounded-full text-sm text-white ${myAttendanceToday.status === 'Hadir' ? 'bg-green-500' : myAttendanceToday.status === 'Izin' ? 'bg-yellow-500' : 'bg-red-500'}`}>{myAttendanceToday.status}</span></div>
                        ) : (
                            <div className="flex gap-2"><Button variant="success" onClick={() => handleAttend(ekskul.id, 'Hadir')}>Hadir</Button><Button variant="secondary" className="bg-yellow-400 text-white hover:bg-yellow-500" onClick={() => handleAttend(ekskul.id, 'Izin')}>Izin</Button><Button variant="danger" onClick={() => handleAttend(ekskul.id, 'Sakit')}>Sakit</Button></div>
                        )}
                    </Card>
            	)})}
                </div>
            </div>
    	)
	}
 
	// Teacher View
	const myEkskuls = db.ekskul.filter(e => e.coachId === currentUser.id);
	return (
    	<div>
            <PageTitle title="Data Absensi Siswa" subtitle="Lihat dan kelola kehadiran siswa di ekstrakurikuler Anda."/>
         	<div className="space-y-6">
                {myEkskuls.map(ekskul => (
     	           <Card key={ekskul.id}>
                        <h3 className="text-xl font-bold text-gray-800 mb-4">{ekskul.name}</h3>
                         <table className="min-w-full">
                            <thead><tr><th className="text-left py-2">Nama Siswa</th><th className="text-left py-2">Tanggal</th><th className="text-left py-2">Status</th></tr></thead>
                            <tbody>
                                {db.attendance.filter(att => att.ekskulId === ekskul.id).map(att => (
          	                      <tr key={att.id} className="border-t">
                                        <td className="py-2">{findUser(att.studentId)?.name}</td>
                                        <td className="py-2">{att.date}</td>
                                        <td className="py-2">
                                            <select value={att.status} onChange={(e) => updateAttendance(att.id, e.target.value)} className="p-1 border border-gray-300 rounded bg-white">
                                                <option>Hadir</option><option>Izin</option><option>Sakit</option><option>Alpha</option>
                                            </select>
                                        </td>
                                	</tr>
                            	))}
                            </tbody>
               	     </table>
                    </Card>
            	))}
            </div>
    	</div>
	)
}
 
const ForumPage = () => {
	const { currentUser, db, findEkskul, findUser, addForum, addForumPost } = useAppContext();
	const [reply, setReply] = useState({});
	const [isCreating, setIsCreating] = useState(false);
	const [newForum, setNewForum] = useState({ title: '', ekskulId: '' });
 
	const myEkskuls = db.ekskul.filter(e => e.coachId === currentUser.id);
 	
    useEffect(() => {
        if (myEkskuls.length > 0 && newForum.ekskulId === '') {
            setNewForum(prev => ({ ...prev, ekskulId: myEkskuls[0].id }));
        }
    }, [myEkskuls]);
 
	const myEkskulIds = currentUser.role === 'student'
    	? db.registrations.filter(r => r.studentId === currentUser.id).map(r => r.ekskulId)
    	: db.ekskul.filter(e => e.coachId === currentUser.id).map(e => e.id);
	const myForums = db.forum.filter(f => myEkskulIds.includes(f.ekskulId));
 
	const handleReplySubmit = (forumId) => {
        if(!reply[forumId]?.trim()) return;
        addForumPost(forumId, { authorId: currentUser.id, message: reply[forumId] });
    	setReply(prev => ({ ...prev, [forumId]: '' }));
	}
	
	const handleCreateForum = (e) => {
        e.preventDefault();
        if(!newForum.title.trim() || !newForum.ekskulId) return;
    	addForum({ ...newForum, authorId: currentUser.id });
        setIsCreating(false);
    	setNewForum({ title: '', ekskulId: myEkskuls.length > 0 ? myEkskuls[0].id : '' });
	}
 
	return (
    	<div>
            <PageTitle title="Forum Diskusi" subtitle="Tempat berdiskusi seputar kegiatan ekstrakurikuler Anda." />
            {currentUser.role === 'teacher' && <div className="flex justify-end mb-4"><Button onClick={() => setIsCreating(!isCreating)}><PlusIcon /> {isCreating ? 'Batal' : 'Buat Forum Baru'}</Button></div>}
            {isCreating && (
                <Card className="mb-6">
                    <form onSubmit={handleCreateForum} className="flex gap-4 items-center">
                         <select value={newForum.ekskulId} onChange={e => setNewForum({...newForum, ekskulId: e.target.value})} className="p-2 border border-gray-300 rounded bg-white">
                           {myEkskuls.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
          	          </select>
                        <input type="text" placeholder="Judul Forum" value={newForum.title} onChange={e => setNewForum({...newForum, title: e.target.value})} className="flex-grow p-2 border border-gray-300 rounded"/>
                        <Button type="submit">Buat</Button>
                    </form>
                </Card>
        	)}
        	<div className="space-y-6">
                {myForums.map(forum => (
                    <Card key={forum.id}>
                        <h3 className="text-xl font-bold">{forum.title}</h3>
                        <p className="text-sm text-gray-500 mb-4">Ekskul: {findEkskul(forum.ekskulId)?.name}</p>
                        <div className="space-y-4 border-t pt-4">
                            {forum.posts.map((post, index) => (
                            	<div key={index} className="flex gap-3">
                                	<div className={`w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center text-white font-bold ${findUser(post.authorId)?.role === 'teacher' ? 'bg-orange-500' : 'bg-blue-500'}`}>{findUser(post.authorId)?.name.charAt(0)}</div>
                                    <div><p className="font-semibold">{findUser(post.authorId)?.name}</p><p>{post.message}</p></div>
  	                          </div>
                            ))}
                        </div>
                         <div className="mt-4 pt-4 border-t flex gap-2">
                             <input type="text" placeholder="Tulis balasan..." value={reply[forum.id] || ''} onChange={e => setReply(prev => ({ ...prev, [forum.id]: e.target.value }))} className="w-full px-4 py-2 border border-gray-300 rounded-lg"/>
                             <Button onClick={() => handleReplySubmit(forum.id)}>Kirim</Button>
         	           </div>
                    </Card>
            	))}
            </div>
    	</div>
	);
};
 
const GalleryPage = () => {
	const { currentUser, db, findEkskul, addPhoto, deletePhoto, showModal } = useAppContext();
	const [isAdding, setIsAdding] = useState(false);
	const [newPhoto, setNewPhoto] = useState({ imageUrl: '', caption: '', ekskulId: '' });
	
	const myEkskuls = db.ekskul.filter(e => e.coachId === currentUser.id);
    
    useEffect(() => {
        if(myEkskuls.length > 0 && newPhoto.ekskulId === '') {
            setNewPhoto(prev => ({...prev, ekskulId: myEkskuls[0].id}));
        }
    }, [myEkskuls]);
 
	const myEkskulIds = currentUser.role === 'student' ? db.registrations.filter(r => r.studentId === currentUser.id).map(r => r.ekskulId) : myEkskuls.map(e => e.id);
	const myGallery = db.gallery.filter(g => myEkskulIds.includes(g.ekskulId));
 
	const handleAddPhoto = (e) => {
        e.preventDefault();
        addPhoto(newPhoto);
        setIsAdding(false);
    	setNewPhoto({ imageUrl: '', caption: '', ekskulId: myEkskuls.length > 0 ? myEkskuls[0].id : '' });
	}
 
	return (
    	<div>
            <PageTitle title="Galeri Kegiatan" subtitle="Dokumentasi momen seru dari setiap ekstrakurikuler."/>
            {currentUser.role === 'teacher' && <div className="flex justify-end mb-4"><Button onClick={() => setIsAdding(!isAdding)}><PlusIcon/> {isAdding ? 'Batal' : 'Unggah Foto'}</Button></div>}
        	{isAdding && (
                <Card className="mb-6">
                    <form onSubmit={handleAddPhoto} className="flex gap-4 items-center">
                        <input type="text" placeholder="URL Gambar" value={newPhoto.imageUrl} onChange={e => setNewPhoto({...newPhoto, imageUrl: e.target.value})} className="flex-grow p-2 border border-gray-300 rounded" required />
                        <input type="text" placeholder="Keterangan" value={newPhoto.caption} onChange={e => setNewPhoto({...newPhoto, caption: e.target.value})} className="flex-grow p-2 border border-gray-300 rounded" required />
                        <select value={newPhoto.ekskulId} onChange={e => setNewPhoto({...newPhoto, ekskulId: e.target.value})} className="p-2 border border-gray-300 rounded bg-white">
                           {myEkskuls.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                        </select>
                        <Button type="submit">Unggah</Button>
                    </form>
                </Card>
        	)}
        	<div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                {myGallery.map(photo => (
                    <div key={photo.id} className="bg-white rounded-lg shadow-md overflow-hidden group relative">
                        <img src={photo.imageUrl} alt={photo.caption} className="w-full h-48 object-cover"/>
                        <div className="p-4">
                            <p className="font-semibold">{photo.caption}</p>
                            <p className="text-sm text-gray-500">Ekskul: {findEkskul(photo.ekskulId)?.name}</p>
                        </div>
                        {currentUser.role === 'teacher' && myEkskulIds.includes(photo.ekskulId) &&
                            <button onClick={() => showModal({title:'Konfirmasi Hapus', content: 'Hapus foto ini?', onConfirm: () => deletePhoto(photo.id)})} className="absolute top-2 right-2 bg-red-500 text-white rounded-full p-2 opacity-0 group-hover:opacity-100 transition-opacity"><TrashIcon/></button>
                        }
                    </div>
       	     ))}
            </div>
    	</div>
	);
}
 
// --- Main App Component ---
function AppContent() {
	const { currentUser } = useAppContext();
	const [currentPage, setCurrentPage] = useState('dashboard');
	
	if (!currentUser) return <LoginPage />;
 
	const defaultPage = currentUser.role === 'teacher' ? 'teacher_dashboard' : 'student_dashboard';
	const pageToRender = currentPage === 'dashboard' ? defaultPage : currentPage;
	
	const renderPage = () => {
        switch(pageToRender) {
        	case 'student_dashboard': return <StudentDashboard />;
        	case 'teacher_dashboard': return <TeacherDashboard />;
        	case 'registration': return <RegistrationPage />;
        	case 'schedule': return <SchedulePage />;
        	case 'attendance': return <AttendancePage />;
        	case 'forum': return <ForumPage />;
        	case 'gallery': return <GalleryPage />;
        	case 'profile': return <ProfilePage />;
        	case 'manage_data': return <ManageDataPage />;
        	default: return <div>Halaman tidak ditemukan</div>;
    	}
	}
	return (
        <AppLayout currentPage={pageToRender} setCurrentPage={setCurrentPage}>
            {renderPage()}
            <Modal />
            <Toast />
        </AppLayout>
    );
}
 
export default function App() {
	return (<AppProvider><AppContent /></AppProvider>);
}
